{"remainingRequest":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\githubdesk\\Movie-Recommendation\\vue-blog\\src\\views\\MovieDIY.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\src\\views\\MovieDIY.vue","mtime":1763815772863},{"path":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\githubdesk\\Movie-Recommendation\\vue-blog\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQppbXBvcnQgTW92aWVJdGVtIGZyb20gJ0AvY29tcG9uZW50cy9tb3ZpZS9Nb3ZpZUl0ZW0nDQppbXBvcnQgQmFzZTQwNCBmcm9tICdAL2NvbXBvbmVudHMvYmFzZS9CYXNlNDA0LnZ1ZSc7DQppbXBvcnQgUVMgZnJvbSAncXMnDQppbXBvcnQgXyBmcm9tICdsb2Fkc2gnDQpjb25zdCBUSCA9IDIwMDsNCmV4cG9ydCBkZWZhdWx0IHsNCiAgbmFtZTogJ01vdmllTGlzdCcsDQogIGluamVjdDogWydjbG9zZUxvYWRDbG9jayddLA0KICBjb21wb25lbnRzOiB7DQogICAgTW92aWVJdGVtLCBCYXNlNDA0DQogIH0sDQogIHByb3BzOiB7DQogICAgbG9hZGluZzogew0KICAgICAgdHlwZTogQm9vbGVhbg0KICAgIH0NCiAgfSwNCiAgZGF0YSgpIHsNCiAgICByZXR1cm4gew0KICAgICAgbW92aWVzOiBbXSwNCiAgICAgIHBhZ2U6IDEsDQogICAgICBzaXplOiAyMDAsDQogICAgICBzY3JvbGxUb3A6IDAsDQogICAgICBzaG93NDA0OiBmYWxzZSwNCiAgICAgIHE6JycsDQogICAgICBxdWVyeTogew0KICAgICAgICBjb2x1bW46ICcnLA0KICAgICAgICBxOiAnJywNCiAgICAgIH0sDQogICAgICB1c2VySW5mbzogdGhpcy4kc3RvcmUuc3RhdGUudXNlckluZm8sDQogICAgfTsNCiAgfSwNCiAgd2F0Y2g6IHsNCiAgICBsb2FkaW5nKGxvYWQpIHsNCiAgICAgIGlmIChsb2FkKSB7DQogICAgICAgIHRoaXMuZ2V0TW92aWVzKCkNCiAgICAgIH0NCiAgICB9LA0KICAgICRyb3V0ZTogew0KICAgICAgaGFuZGxlcigpIHsNCiAgICAgICAgdGhpcy5oYW5kbGVSb3V0ZUNoYW5nZSgpDQoNCiAgICAgIH0sDQoNCiAgICAgIGltbWVkaWF0ZTogdHJ1ZQ0KICAgIH0NCiAgfSwNCiAgYWN0aXZhdGVkKCkgew0KICAgIGlmICh0aGlzLnNjcm9sbFRvcCkgew0KICAgICAgdGhpcy4kcmVmc1snc2Nyb2xsVmlldyddLnNjcm9sbFRvKHsNCiAgICAgICAgeTogdGhpcy5zY3JvbGxUb3ANCiAgICAgIH0sIDMwMCkNCiAgICB9DQoNCiAgICBpZiAodGhpcy4kcm91dGUucXVlcnk/LmNvbHVtbklkKSB7DQogICAgICB0aGlzLnF1ZXJ5LmNvbHVtbiA9IHRoaXMuJHJvdXRlLnF1ZXJ5Py5jb2x1bW5JZA0KICAgIH0NCiAgfSwNCg0KICBkZWFjdGl2YXRlZCgpIHsNCiAgICB0aGlzLnF1ZXJ5ID0gew0KICAgICAgY29sdW1uOiAnJywNCiAgICAgIHE6ICcnDQogICAgfQ0KICB9LA0KICBjcmVhdGVkKCkgew0KICAgIHRoaXMuZ2V0TW92aWVzKCkNCg0KICB9LA0KICBtb3VudGVkKCkgew0KICAgIHRoaXMuJEV2ZW50QnVzLiRvbigndXBkYXRlVmlldycsICgpID0+IHsNCiAgICAgIHRoaXMuZ2V0TW92aWVzKCkNCg0KICAgIH0pDQoNCiAgICB0aGlzLiRFdmVudEJ1cy4kb24oJ2FjdGl2ZVNlYXJjaCcsIChxKSA9PiB7DQogICAgICB0aGlzLnEgPSBxDQogICAgICB0aGlzLmNhbmNlbE1vdmllcygpDQogICAgICB0aGlzLmdldE1vdmllcygpDQogICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgdGhpcy5yZWZyZXNoU2VhcmNoKCkNCiAgICAgIH0sIDEwMDApDQogICAgfSkNCiAgfSwNCiAgbWV0aG9kczogew0KICAgIGhhbmRsZVJvdXRlQ2hhbmdlKCkgew0KICAgICAgLy8g5qOA5p+l5p+l6K+i5Y+C5pWw5piv5ZCm5Y+R55Sf5Y+Y5YyWDQogICAgICBjb25zdCBuZXdDb2x1bW4gPSB0aGlzLiRyb3V0ZS5xdWVyeT8uY29sdW1uSWQgfHwgJyc7DQogICAgICBjb25zdCBuZXdRID0gdGhpcy4kcm91dGUucXVlcnk/LnEgfHwgJyc7DQoNCiAgICAgIC8vIOWmguaenOafpeivouWPguaVsOWPkeeUn+S6huWPmOWMlu+8jOmHjeaWsOWKoOi9veaVsOaNrg0KICAgICAgaWYgKHRoaXMucXVlcnkuY29sdW1uICE9PSBuZXdDb2x1bW4gfHwgdGhpcy5xdWVyeS5xICE9PSBuZXdRKSB7DQogICAgICAgIGNvbnNvbGUubG9nKCfmn6Xor6Llj4LmlbDlj5HnlJ/kuoblj5jljJbvvIzph43mlrDliqDovb3mlbDmja4nKTsNCiAgICAgICAgdGhpcy5xdWVyeS5jb2x1bW4gPSBuZXdDb2x1bW47DQogICAgICAgIHRoaXMucXVlcnkucSA9IG5ld1E7DQogICAgICAgIHRoaXMuY2FuY2VsTW92aWVzKCk7DQogICAgICAgIHRoaXMuZ2V0TW92aWVzKCk7DQogICAgICB9DQogICAgfSwNCiAgICByb3V0ZU1vdmllKGlkKSB7DQogICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7IG5hbWU6ICdtb3ZpZScsIHBhcmFtczogeyBpZDogaWQgfSB9KQ0KICAgIH0sDQogICAgcmVmcmVzaFNlYXJjaCgpew0KICAgICAgdGhpcy5xPScnDQogICAgfSwNCiAgICBzZXRRdWVyeSgpIHsNCiAgICAgIGxldCBjb2x1bW4gPSB0aGlzLiRyb3V0ZS5xdWVyeT8uY29sdW1uSWQNCiAgICAgIGxldCBxID0gdGhpcy5xfHx1bmRlZmluZWQ7DQogICAgICBsZXQgcXVlcnkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHsNCiAgICAgICAgY29sdW1uLCBxLA0KICAgICAgfSkpDQogICAgICByZXR1cm4gcXVlcnkNCiAgICB9LA0KICAgIGNhbmNlbE1vdmllcygpIHsNCiAgICAgIHRoaXMucGFnZSA9IDENCiAgICAgIHRoaXMubW92aWVzID0gW10NCiAgICB9LA0KDQogICAgbG9hZE1vcmU6IF8udGhyb3R0bGUoZnVuY3Rpb24gKHZlcnRpY2FsLCBob3Jpem9udGFsLCBuYXRpdmVFdmVudCkgew0KICAgICAgdGhpcy5zY3JvbGxUb3AgPSB2ZXJ0aWNhbC5zY3JvbGxUb3ANCg0KICAgICAgaWYgKHRoaXMubG9hZGluZykgew0KICAgICAgICByZXR1cm4NCiAgICAgIH0NCiAgICAgIGxldCBzdCA9IHZlcnRpY2FsLnNjcm9sbFRvcA0KICAgICAgbGV0IHNoID0gbmF0aXZlRXZlbnQuc3JjRWxlbWVudC5zY3JvbGxIZWlnaHQgLSBuYXRpdmVFdmVudC5zcmNFbGVtZW50LmNsaWVudEhlaWdodA0KDQogICAgICBpZiAoc3QgKyBUSCA+IHNoKSB7DQogICAgICAgIGNvbnNvbGUubG9nKCfliqDovb3mm7TlpJonKQ0KICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlDQogICAgICAgIHRoaXMuZ2V0TW92aWVzKCkNCiAgICAgIH0NCiAgICB9LCA1MDAsIGZhbHNlKSwNCiAgICBnZXRNb3ZpZXMoKSB7DQoNCiAgICAgIGxldCBkYXRhID0geyBzaXplOiB0aGlzLnNpemUsIHBhZ2U6IHRoaXMucGFnZX0gDQogICAgICBsZXQgcXVlcnkgPSB0aGlzLnNldFF1ZXJ5KCkNCiAgICAgIGlmIChPYmplY3QuZW50cmllcyhxdWVyeSkubGVuZ3RoID4gMCkgew0KICAgICAgICBkYXRhLnF1ZXJ5ID0gUVMuc3RyaW5naWZ5KHF1ZXJ5KQ0KICAgICAgfQ0KICAgICAgY29uc29sZS5sb2coZGF0YSkNCiAgICAgIHRoaXMuJGFwaSh7IHR5cGU6ICdtb3ZpZXMnLCBkYXRhIH0pLnRoZW4ocmVzdWx0ID0+IHsNCiAgICAgICAgLy8g5YWz6ZSu5L+u5pS577ya5Zyo6L+Z6YeM5Yik5pat5piv5ZCm5pi+56S6NDA06aG16Z2iDQogICAgICAgIGlmIChyZXN1bHQubGlzdC5sZW5ndGggPT09IDAgJiYgdGhpcy5wYWdlID09PSAxKSB7DQogICAgICAgICAgLy8g5pCc57Si5L2G5rKh5pyJ57uT5p6c77yM5pi+56S6NDA0DQogICAgICAgICAgdGhpcy5zaG93NDA0ID0gdHJ1ZTsNCiAgICAgICAgICB0aGlzLm1vdmllcyA9IFtdOw0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMubW92aWVzLmxlbmd0aCA+PSByZXN1bHQudG90YWwpIHsNCiAgICAgICAgICAvLyDmsqHmnInmm7TlpJrkuoYNCiAgICAgICAgICBjb25zb2xlLmxvZygn5rKh5pyJ5pu05aSa5LqGJykNCiAgICAgICAgICByZXR1cm4NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAvLyDmraPluLjmmL7npLrmlofnq6ANCiAgICAgICAgICB0aGlzLnNob3c0MDQgPSBmYWxzZTsNCiAgICAgICAgICBsZXQgY29sbGVjdExpc3Q9dGhpcy51c2VySW5mby5jb2xsZWN0TGlzdC5tYXAoaXRlbT0+aXRlbS50b1N0cmluZygpKQ0KICAgICAgICAgIGxldCBkaXlMaXN0PXJlc3VsdC5saXN0LmZpbHRlcihpdGVtPT57DQogICAgICAgICAgICByZXR1cm4gaXRlbS5faWQudG9TdHJpbmcoKSBpbiBjb2xsZWN0TGlzdA0KICAgICAgICAgIH0pDQogICAgICAgICAgY29uc29sZS5sb2coZGl5TGlzdCkNCiAgICAgICAgICB0aGlzLm1vdmllcy5wdXNoKC4uLmRpeUxpc3QpDQogICAgICAgICAgdGhpcy5jbG9zZUxvYWRDbG9jaygpIC8v6LCD55So54i257uE5Lu2cHJvdmlkZeS8oOmAkueahOWFs+mXrWxvYWTplIHmlrnms5UNCiAgICAgICAgICB0aGlzLnBhZ2UrKw0KICAgICAgICB9DQogICAgICB9KS5jYXRjaChlcnIgPT4gew0KICAgICAgICB0aGlzLiRub3RpZnkuZXJyb3Ioew0KICAgICAgICAgIHRpdGxlOiAn6I635Y+W5aSx6LSlJywNCiAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZQ0KICAgICAgICB9KQ0KICAgICAgfSkNCiAgICB9DQogIH0sDQp9Ow0K"},{"version":3,"sources":["MovieDIY.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;AAeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"MovieDIY.vue","sourceRoot":"src/views","sourcesContent":["<template>\r\n\r\n  <div class=\"article-wrap\" v-if=\"movies && !show404\">\r\n    <Scroll @handle-scroll=\"loadMore\" ref=\"scrollView\">\r\n      <div class=\"blog-content--item\" v-for=\"item in movies\" :key=\"item.id\">\r\n        <router-link :to=\"{ name: 'movie', params: { id: item._id } }\">\r\n          <MovieItem :movie=\"item\" />\r\n        </router-link>\r\n      </div>\r\n    </Scroll>\r\n  </div>\r\n  <Base404 v-else-if=\"show404\" />\r\n</template>\r\n\r\n<script>\r\nimport MovieItem from '@/components/movie/MovieItem'\r\nimport Base404 from '@/components/base/Base404.vue';\r\nimport QS from 'qs'\r\nimport _ from 'loadsh'\r\nconst TH = 200;\r\nexport default {\r\n  name: 'MovieList',\r\n  inject: ['closeLoadClock'],\r\n  components: {\r\n    MovieItem, Base404\r\n  },\r\n  props: {\r\n    loading: {\r\n      type: Boolean\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      movies: [],\r\n      page: 1,\r\n      size: 200,\r\n      scrollTop: 0,\r\n      show404: false,\r\n      q:'',\r\n      query: {\r\n        column: '',\r\n        q: '',\r\n      },\r\n      userInfo: this.$store.state.userInfo,\r\n    };\r\n  },\r\n  watch: {\r\n    loading(load) {\r\n      if (load) {\r\n        this.getMovies()\r\n      }\r\n    },\r\n    $route: {\r\n      handler() {\r\n        this.handleRouteChange()\r\n\r\n      },\r\n\r\n      immediate: true\r\n    }\r\n  },\r\n  activated() {\r\n    if (this.scrollTop) {\r\n      this.$refs['scrollView'].scrollTo({\r\n        y: this.scrollTop\r\n      }, 300)\r\n    }\r\n\r\n    if (this.$route.query?.columnId) {\r\n      this.query.column = this.$route.query?.columnId\r\n    }\r\n  },\r\n\r\n  deactivated() {\r\n    this.query = {\r\n      column: '',\r\n      q: ''\r\n    }\r\n  },\r\n  created() {\r\n    this.getMovies()\r\n\r\n  },\r\n  mounted() {\r\n    this.$EventBus.$on('updateView', () => {\r\n      this.getMovies()\r\n\r\n    })\r\n\r\n    this.$EventBus.$on('activeSearch', (q) => {\r\n      this.q = q\r\n      this.cancelMovies()\r\n      this.getMovies()\r\n      setTimeout(() => {\r\n        this.refreshSearch()\r\n      }, 1000)\r\n    })\r\n  },\r\n  methods: {\r\n    handleRouteChange() {\r\n      // 检查查询参数是否发生变化\r\n      const newColumn = this.$route.query?.columnId || '';\r\n      const newQ = this.$route.query?.q || '';\r\n\r\n      // 如果查询参数发生了变化，重新加载数据\r\n      if (this.query.column !== newColumn || this.query.q !== newQ) {\r\n        console.log('查询参数发生了变化，重新加载数据');\r\n        this.query.column = newColumn;\r\n        this.query.q = newQ;\r\n        this.cancelMovies();\r\n        this.getMovies();\r\n      }\r\n    },\r\n    routeMovie(id) {\r\n      this.$router.push({ name: 'movie', params: { id: id } })\r\n    },\r\n    refreshSearch(){\r\n      this.q=''\r\n    },\r\n    setQuery() {\r\n      let column = this.$route.query?.columnId\r\n      let q = this.q||undefined;\r\n      let query = JSON.parse(JSON.stringify({\r\n        column, q,\r\n      }))\r\n      return query\r\n    },\r\n    cancelMovies() {\r\n      this.page = 1\r\n      this.movies = []\r\n    },\r\n\r\n    loadMore: _.throttle(function (vertical, horizontal, nativeEvent) {\r\n      this.scrollTop = vertical.scrollTop\r\n\r\n      if (this.loading) {\r\n        return\r\n      }\r\n      let st = vertical.scrollTop\r\n      let sh = nativeEvent.srcElement.scrollHeight - nativeEvent.srcElement.clientHeight\r\n\r\n      if (st + TH > sh) {\r\n        console.log('加载更多')\r\n        this.loading = true\r\n        this.getMovies()\r\n      }\r\n    }, 500, false),\r\n    getMovies() {\r\n\r\n      let data = { size: this.size, page: this.page} \r\n      let query = this.setQuery()\r\n      if (Object.entries(query).length > 0) {\r\n        data.query = QS.stringify(query)\r\n      }\r\n      console.log(data)\r\n      this.$api({ type: 'movies', data }).then(result => {\r\n        // 关键修改：在这里判断是否显示404页面\r\n        if (result.list.length === 0 && this.page === 1) {\r\n          // 搜索但没有结果，显示404\r\n          this.show404 = true;\r\n          this.movies = [];\r\n        } else if (this.movies.length >= result.total) {\r\n          // 没有更多了\r\n          console.log('没有更多了')\r\n          return\r\n        } else {\r\n          // 正常显示文章\r\n          this.show404 = false;\r\n          let collectList=this.userInfo.collectList.map(item=>item.toString())\r\n          let diyList=result.list.filter(item=>{\r\n            return item._id.toString() in collectList\r\n          })\r\n          console.log(diyList)\r\n          this.movies.push(...diyList)\r\n          this.closeLoadClock() //调用父组件provide传递的关闭load锁方法\r\n          this.page++\r\n        }\r\n      }).catch(err => {\r\n        this.$notify.error({\r\n          title: '获取失败',\r\n          message: err.message\r\n        })\r\n      })\r\n    }\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"stylus\">\r\n.article-wrap\r\n  overflow hidden\r\n  height 100%\r\n</style>"]}]}